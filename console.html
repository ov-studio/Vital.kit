<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Console</title>
        <link rel="preconnect" href="https://fonts.googleapis.com"/>
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@400;500;600;700&family=Geist:wght@400;500;600;700&display=swap"/>

        <style>
            :root {
                --radius: 0.3rem;
                --bg-deep: hsl(250 20% 3%);
                --bg-card: hsl(250 20% 4%);
                --border: hsl(220, 15%, 15%);
                --fg: hsl(220, 15%, 87%);
                --fg-muted: hsl(220, 15%, 60%);
                --accent-bg: hsl(0 0% 14.9%);
                --accent-hover: hsl(0 0% 25%);
                --row-hover: hsl(0 0% 100%/0.03);
                --shadow-inset: hsl(0 0% 100%/0.04);
                --shadow-dark: hsl(0 0% 0%/0.4);
                --shadow-darker: hsl(0 0% 0%/0.5);
                --badge-bg: hsl(220, 15%, 15%);
                --selection-bg: #ff0066;
                --selection-fg: #ffffff;
            }

            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            *::selection {
                color: var(--selection-fg);
                background: var(--selection-bg);
            }

            html,
            body,
            #root {
                width: 100%;
                height: 100%;
                background: transparent;
                color: var(--fg);
                font-family: 'Geist', monospace;
                font-size: 13.5px;
                -webkit-font-smoothing: antialiased;
            }

            .console {
                position: absolute;
                background: var(--bg-card);
                border-radius: calc(var(--radius) + 2px);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                box-shadow: 0 0 0 1px var(--shadow-inset) inset, 0 4px 6px -1px var(--shadow-dark), 0 10px 30px -5px var(--shadow-darker);
            }

            .header {
                height: 48px;
                display: flex;
                align-items: center;
                padding: 0 4px 0 14px;
                gap: 10px;
                background: var(--bg-deep);
                border-bottom: 1px solid var(--border);
                cursor: grab;
                user-select: none;
                flex-shrink: 0;
            }

            .header.dragging {
                cursor: grabbing;
            }

            .titlebar-label {
                font-size: 13px;
                font-weight: 600;
                color: var(--fg-muted);
                letter-spacing: 0.02em;
                flex-shrink: 0;
            }

            .header-divider {
                width: 1px;
                height: 16px;
                background: var(--border);
                flex-shrink: 0;
            }

            .filters {
                display: flex;
                align-items: center;
                gap: 4px;
                flex: 1;
            }

            .filter {
                opacity: 0.45;
                height: 22px;
                padding: 0 8px;
                font-size: 12px;
                font-weight: 600;
                letter-spacing: 0.04em;
                border-radius: calc(var(--radius) - 1px);
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 5px;
                transition: background 0.12s, color 0.12s, opacity 0.12s;
                color: var(--fg-muted);
                background: transparent;
            }

            .filter:hover {
                opacity: 0.75;
                background: var(--accent-bg);
            }

            .filter.active {
                opacity: 1;
            }

            .filter-dot {
                width: 5px;
                height: 5px;
                border-radius: 50%;
                background: currentColor;
                flex-shrink: 0;
            }

            .filter-count {
                opacity: 0.6;
                font-size: 10px;
                font-weight: 700;
            }

            .log-row.hidden {
                display: none;
            }

            .tabbar-actions {
                margin-left: auto;
                display: flex;
                align-items: center;
                gap: 4px;
                padding-right: 4px;
            }

            .icon-btn {
                width: 26px;
                height: 26px;
                border-radius: calc(var(--radius) - 2px);
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--fg-muted);
                cursor: pointer;
                border: none;
                background: transparent;
                transition: background 0.12s, color 0.12s;
            }

            .icon-btn-labeled {
                width: auto;
                height: 22px;
                padding: 0 8px;
                gap: 5px;
                background: var(--badge-bg);
            }

            .btn-label {
                font-size: 12px;
                font-weight: 600;
                letter-spacing: 0.04em;
            }

            .icon-btn:hover {
                background: var(--accent-bg);
                color: var(--fg);
            }

            .log-body {
                flex: 1;
                overflow-y: auto;
                padding: 10px 0;
                scroll-behavior: smooth;
            }

            .log-body::-webkit-scrollbar {
                width: 6px;
            }

            .log-body::-webkit-scrollbar-track {
                background: transparent;
            }

            .log-body::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 9px;
            }

            .log-body::-webkit-scrollbar-thumb:hover {
                background: var(--accent-hover);
            }

            .log-row {
                display: flex;
                padding: 4px 14px;
                margin-bottom: 1px;
                white-space: pre-wrap;
                word-break: break-all;
                transition: background 0.08s;
                line-height: 16px;
                align-items: center;
            }

            .log-row:hover {
                background: var(--row-hover);
            }

            .log-ts {
                color: var(--fg-muted);
                font-family: 'Geist Mono', monospace;
                font-size: 12.5px;
                min-width: 88px;
                flex-shrink: 0;
                letter-spacing: 0.0em;
            }

            .log-level {
                opacity: 0.55;
                min-width: 46px;
                font-family: 'Geist Mono', monospace;
                font-size: 11px;
                font-weight: 800;
                flex-shrink: 0;
                letter-spacing: 0.05em;
            }

            .log-msg {
                flex: 1;
                font-size: 13px;
                letter-spacing: 0.01em;
            }

            .badge {
                display: none;
                margin-left: 10px;
                padding: 3px 6px;
                font-size: 10.5px;
                font-weight: 700;
                letter-spacing: 0.0em;
                border-radius: calc(var(--radius) - 2px);
                flex-shrink: 0;
                align-self: center;
                line-height: 1.3;
                color: var(--fg-muted);
                background: var(--badge-bg);
                transition: transform 0.07s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .badge.visible {
                display: inline-block;
            }

            .input-bar {
                height: 38px;
                display: flex;
                align-items: center;
                padding: 0 14px;
                border-top: 1px solid var(--border);
                gap: 8px;
                background: var(--bg-deep);
                flex-shrink: 0;
            }

            .input-prompt {
                color: var(--fg-muted);
                font-size: 13px;
                flex-shrink: 0;
            }

            .input-field {
                flex: 1;
                background: transparent;
                border: none;
                outline: none;
                color: var(--fg-muted);
                font-family: inherit;
                font-size: 13px;
                caret-color: hsl(220 13% 78%);
            }

            .input-field::placeholder {
                opacity: 0.6;
                color: var(--fg-muted);
            }

            .resize-handle {
                opacity: 0.3;
                position: absolute;
                right: 3px;
                bottom: 3px;
                width: 14px;
                height: 14px;
                cursor: se-resize;
                overflow: hidden;
            }

            .resize-handle::before,
            .resize-handle::after,
            .resize-handle span {
                content: '';
                position: absolute;
                background: var(--fg-muted);
                width: 140%;
                height: 1px;
                transform-origin: right center;
                transform: rotate(-45deg);
                right: 0;
            }

            .resize-handle::before {
                bottom: 1px;
            }

            .resize-handle span {
                bottom: 5px;
            }

            .resize-handle::after {
                bottom: 9px;
            }

            .resize-handle:hover {
                opacity: 0.8;
            }
        </style>
    </head>

    <body>
        <!-- React -->
        <div id="root"></div>
        <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <script type="text/babel">
            // CONSTANTS
            const GROUP_MS = 5000;
            const { useState, useEffect, useRef, useCallback, useMemo } = React;
            const LEVELS = {
                info: {
                    label: 'Info',
                    badge: 'INFO',
                    priority: 1,
                    label_color: 'hsl(220 13% 78%)',
                    bg_color: 'hsl(220 13% 78%/0.1)'
                },
                warn: {
                    label: 'Warn',
                    badge: 'WARN',
                    priority: 2,
                    label_color: 'hsl(38 92% 66%)',
                    bg_color: 'hsl(38 92% 66%/0.1)'
                },
                error: {
                    label: 'Error',
                    badge: 'ERRO',
                    priority: 3,
                    label_color: 'hsl(0 72% 66%)',
                    bg_color: 'hsl(0 72% 66%/0.1)'
                }
            };

            // ICONS
            const Trash2 = ({ size = 24, strokeWidth = 2, ...props }) => (
                <svg
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth={strokeWidth}
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    {...props}
                >
                    <path d="M3 6h18"/>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            );

            const RotateCcw = ({ size = 24, strokeWidth = 2, ...props }) => (
                <svg
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth={strokeWidth}
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    {...props}
                >
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
            );

            // UTILITIES
            const make_key = (type, msg) => {
                return type + '\x00' + msg
                    .replace(/\d+\.\d+/g, '#')
                    .replace(/\b\d+\b/g, '#')
                    .replace(/\s+/g, ' ')
                    .trim();
            };

            const get_sorted_level_types = () => {
                return Object.entries(LEVELS)
                    .sort(([, a], [, b]) => a.priority - b.priority)
                    .map(([type]) => type);
            };

            // COMPONENTS
            const FilterButton = ({ type, label, count, is_active, on_click, label_color, bg_color }) => {
                const style = type === 'all'
                    ? {
                        color: is_active ? 'var(--fg)' : undefined,
                        backgroundColor: is_active ? 'var(--accent-bg)' : undefined
                    }
                    : {
                        color: is_active ? label_color : undefined,
                        backgroundColor: is_active ? bg_color : undefined
                    };

                return (
                    <div
                        className={`filter ${is_active ? 'active' : ''}`}
                        data-type={type}
                        onClick={on_click}
                        style={style}
                    >
                        <div className="filter-dot"></div>
                        {label}
                        {count > 0 && <span className="filter-count"> ({count})</span>}
                    </div>
                );
            };

            const ActionButton = ({ icon: Icon, label, on_click }) => (
                <button className="icon-btn icon-btn-labeled" onClick={on_click}>
                    <Icon size={12} strokeWidth={2}/>
                    <span className="btn-label">{label}</span>
                </button>
            );

            const LogRow = ({ type, timestamp, message, repeat_count, is_hidden }) => {
                const level_config = LEVELS[type];
                const style = level_config ? { color: level_config.label_color } : {};

                return (
                    <div className={`log-row ${type} ${is_hidden ? 'hidden' : ''}`} style={style}>
                        <span className="log-ts">{timestamp}</span>
                        <span className="log-level">{level_config?.badge ?? type.toUpperCase()}</span>
                        <span className="log-msg">{message}</span>
                        {repeat_count > 1 && <span className="badge visible">x{repeat_count}</span>}
                    </div>
                );
            };

            // MAIN CONSOLE COMPONENT
            const Console = () => {
                // State
                const [logs, set_logs] = useState([]);
                const [command_input, set_command_input] = useState('');
                const [is_dragging, set_is_dragging] = useState(false);

                // Get all level types sorted by priority
                const level_types = useMemo(() => get_sorted_level_types(), []);

                // Initialize active filters with all level types
                const [active_filters, set_active_filters] = useState(new Set(level_types));
                const [position, set_position] = useState({ x: 0, y: 0 });
                const [size, set_size] = useState({ width: '800px', height: '360px' });

                // Refs
                const console_ref = useRef(null);
                const log_body_ref = useRef(null);
                const group_map_ref = useRef(new Map());
                const drag_offset_ref = useRef({ x: 0, y: 0 });

                // Calculate counts
                const log_counts = useMemo(() => {
                    const counts = {};
                    level_types.forEach(type => counts[type] = 0);
                    logs.forEach(log => {
                        if (counts[log.type] !== undefined) {
                            counts[log.type]++;
                        }
                    });
                    return counts;
                }, [logs, level_types]);

                const total_count = useMemo(() =>
                    Object.values(log_counts).reduce((sum, count) => sum + count, 0),
                    [log_counts]
                );

                // Log Management
                const add_log = useCallback((type, message, timestamp = null) => {
                    // Skip if type is not valid
                    if (!type || !message || !LEVELS[type]) return;

                    const ts = timestamp || new Date().toTimeString().slice(0, 8);
                    const now = Date.now();
                    const key = make_key(type, message);

                    // Clean expired groups
                    for (const [k, entry] of group_map_ref.current) {
                        if (now >= entry.expires_at) {
                            group_map_ref.current.delete(k);
                        }
                    }

                    const existing = group_map_ref.current.get(key);

                    if (existing) {
                        // Update existing log
                        existing.count++;
                        existing.expires_at = now + GROUP_MS;
                        existing.timestamp = ts;

                        set_logs(prev_logs =>
                            prev_logs.map(log =>
                                log.id === existing.id
                                    ? { ...log, repeat_count: existing.count, timestamp: ts }
                                    : log
                            )
                        );

                        // Auto-scroll if at bottom
                        setTimeout(() => {
                            const log_el = log_body_ref.current;
                            if (log_el) {
                                const at_bottom = log_el.scrollHeight - log_el.scrollTop - log_el.clientHeight < 6;
                                if (at_bottom) log_el.scrollTop = log_el.scrollHeight;
                            }
                        }, 0);
                    } else {
                        // Add new log
                        const new_log = {
                            id: Date.now() + Math.random(),
                            type,
                            message,
                            timestamp: ts,
                            repeat_count: 1
                        };

                        group_map_ref.current.set(key, {
                            id: new_log.id,
                            count: 1,
                            expires_at: now + GROUP_MS,
                            timestamp: ts
                        });

                        set_logs(prev_logs => [...prev_logs, new_log]);

                        // Auto-scroll to bottom
                        setTimeout(() => {
                            const log_el = log_body_ref.current;
                            if (log_el) log_el.scrollTop = log_el.scrollHeight;
                        }, 0);
                    }
                }, []);

                const clear_logs = useCallback(() => {
                    set_logs([]);
                    group_map_ref.current.clear();
                }, []);

                // Message Handler
                const handle_message = useCallback((e) => {
                    var data = JSON.parse(e.detail);
                    if (data.action === 'print') {
                        add_log(data.mode, data.message);
                    }
                }, [add_log]);

                // Command Handler
                const handle_command = useCallback((command) => {
                    ipc.postMessage(
                        JSON.stringify({
                            action: "command",
                            message: command,
                        })
                    );
                }, []);

                const handle_key_down = useCallback((e) => {
                    if (e.key === 'Enter' && command_input.trim() !== '') {
                        handle_command(command_input);
                        set_command_input('');
                    }
                }, [command_input, handle_command]);

                // Filter Management
                const toggle_filter = useCallback((type) => {
                    if (type === 'all') {
                        // Toggle: if all are currently active, turn all off, otherwise turn all on
                        if (active_filters.size === level_types.length) {
                            set_active_filters(new Set());
                        } else {
                            set_active_filters(new Set(level_types));
                        }
                    } else {
                        set_active_filters(prev => {
                            const new_filters = new Set(prev);
                            if (new_filters.has(type)) {
                                new_filters.delete(type);
                            } else {
                                new_filters.add(type);
                            }
                            return new_filters;
                        });
                    }
                }, [level_types, active_filters.size]);

                // Position Management
                const reset_position = useCallback(() => {
                    set_position({ x: 0, y: 0 });
                }, []);

                // Drag Handlers
                const handle_mouse_down = useCallback((e) => {
                    if (e.target.closest('.icon-btn, .filter')) return;
                    e.preventDefault();
                    set_is_dragging(true);

                    const rect = console_ref.current.getBoundingClientRect();
                    drag_offset_ref.current = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                }, []);

                const handle_mouse_move = useCallback((e) => {
                    if (!is_dragging) return;
                    set_position({
                        x: e.clientX - drag_offset_ref.current.x,
                        y: e.clientY - drag_offset_ref.current.y
                    });
                }, [is_dragging]);

                const handle_mouse_up = useCallback(() => {
                    set_is_dragging(false);
                }, []);

                // Resize Handlers
                const handle_resize_start = useCallback((e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const start_x = e.clientX;
                    const start_y = e.clientY;
                    const rect = console_ref.current.getBoundingClientRect();
                    const start_width = rect.width;
                    const start_height = rect.height;

                    const handle_resize_move = (e) => {
                        const new_width = Math.max(400, start_width + e.clientX - start_x);
                        const new_height = Math.max(260, start_height + e.clientY - start_y);
                        set_size({ width: new_width + 'px', height: new_height + 'px' });
                    };

                    const handle_resize_end = () => {
                        document.removeEventListener('mousemove', handle_resize_move);
                        document.removeEventListener('mouseup', handle_resize_end);
                    };

                    document.addEventListener('mousemove', handle_resize_move);
                    document.addEventListener('mouseup', handle_resize_end);
                }, []);

                // Prevent context menu
                useEffect(() => {
                    const prevent_context = (e) => e.preventDefault();
                    document.addEventListener('contextmenu', prevent_context);
                    return () => document.removeEventListener('contextmenu', prevent_context);
                }, []);

                // Drag event listeners
                useEffect(() => {
                    if (is_dragging) {
                        document.addEventListener('mousemove', handle_mouse_move);
                        document.addEventListener('mouseup', handle_mouse_up);
                        return () => {
                            document.removeEventListener('mousemove', handle_mouse_move);
                            document.removeEventListener('mouseup', handle_mouse_up);
                        };
                    }
                }, [is_dragging, handle_mouse_move, handle_mouse_up]);

                // Message listeners
                useEffect(() => {
                    document.addEventListener('message', handle_message);
                    return () => document.removeEventListener('message', handle_message);
                }, [handle_message]);

                // Render
                return (
                    <div
                        ref={console_ref}
                        className="console"
                        style={{
                            left: `${position.x}px`,
                            top: `${position.y}px`,
                            width: size.width,
                            height: size.height
                        }}
                    >
                        {/* Header */}
                        <div className={`header ${is_dragging ? 'dragging' : ''}`} onMouseDown={handle_mouse_down}>
                            <span className="titlebar-label">Console</span>
                            <div className="header-divider"></div>

                            {/* Filters - Auto-generated */}
                            <div className="filters">
                                <FilterButton
                                    type="all"
                                    label="All"
                                    count={total_count}
                                    is_active={active_filters.size === level_types.length}
                                    on_click={() => toggle_filter('all')}
                                />
                                {level_types.map(type => (
                                    <FilterButton
                                        key={type}
                                        type={type}
                                        label={LEVELS[type].label}
                                        count={log_counts[type]}
                                        is_active={active_filters.has(type)}
                                        on_click={() => toggle_filter(type)}
                                        label_color={LEVELS[type].label_color}
                                        bg_color={LEVELS[type].bg_color}
                                    />
                                ))}
                            </div>

                            {/* Actions */}
                            <div className="tabbar-actions">
                                <ActionButton icon={RotateCcw} label="Reset" on_click={reset_position}/>
                                <ActionButton icon={Trash2} label="Clear" on_click={clear_logs}/>
                            </div>
                        </div>

                        {/* Log Body */}
                        <div ref={log_body_ref} className="log-body">
                            {logs.map(log => (
                                <LogRow
                                    key={log.id}
                                    type={log.type}
                                    timestamp={log.timestamp}
                                    message={log.message}
                                    repeat_count={log.repeat_count}
                                    is_hidden={!active_filters.has(log.type)}
                                />
                            ))}
                        </div>

                        {/* Input Bar */}
                        <div className="input-bar">
                            <span className="input-prompt">‚ùØ</span>
                            <input
                                className="input-field"
                                value={command_input}
                                onChange={(e) => set_command_input(e.target.value)}
                                onKeyDown={handle_key_down}
                                placeholder="Enter command or expression..."
                                autoComplete="off"
                                spellCheck="false"
                            />
                        </div>

                        {/* Resize Handle */}
                        <div className="resize-handle" onMouseDown={handle_resize_start}>
                            <span></span>
                        </div>
                    </div>
                );
            };

            // RENDER APP
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<Console/>);
        </script>
    </body>
</html>