<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Console</title>
        <link rel="preconnect" href="https://fonts.googleapis.com"/>
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
        <link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@400;500;600;700&family=Geist:wght@400;500;600;700&display=swap" rel="stylesheet"/>

        <style>
            :root {
                --bg-deep: hsl(250 20% 3%);
                --bg-card: hsl(250 20% 4%);
                --bg-status: hsl(0 0% 7%);
                --border: hsl(220, 15%, 15%);
                --fg: hsl(220, 15%, 87%);
                --fg-muted: hsl(220, 15%, 60%);
                --fg-dim: hsl(0 0% 35%);
                --accent-bg: hsl(0 0% 14.9%);
                --radius: 0.3rem;
                --log-info: hsl(220 13% 78%);
                --log-warn: hsl(38 92% 66%);
                --log-error: hsl(0 72% 66%);
                --badge-bg: hsl(220, 15%, 15%);
                --badge-fg: hsl(0 0% 60%);
            }

            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            html,
            body,
            #root {
                width: 100%;
                height: 100%;
                background: transparent;
                color: var(--fg);
                font-family: 'Geist', monospace;
                font-size: 13.5px;
                -webkit-font-smoothing: antialiased;
            }

            ::selection {
                background-color: #ff0066;
                color: white;
            }

            .console {
                position: absolute;
                background: var(--bg-card);
                border-radius: calc(var(--radius) + 2px);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                box-shadow: 0 0 0 1px hsl(0 0% 100%/0.04) inset, 0 4px 6px -1px hsl(0 0% 0%/0.4), 0 10px 30px -5px hsl(0 0% 0%/0.5);
            }

            .header {
                height: 48px;
                display: flex;
                align-items: center;
                padding: 0 4px 0 14px;
                gap: 10px;
                background: var(--bg-deep);
                border-bottom: 1px solid var(--border);
                cursor: grab;
                user-select: none;
                flex-shrink: 0;
            }

            .header.dragging {
                cursor: grabbing;
            }

            .titlebar-label {
                font-size: 13px;
                font-weight: 600;
                color: var(--fg-muted);
                letter-spacing: 0.02em;
                flex-shrink: 0;
            }

            .header-divider {
                width: 1px;
                height: 16px;
                background: var(--border);
                flex-shrink: 0;
            }

            .filters {
                display: flex;
                align-items: center;
                gap: 4px;
                flex: 1;
            }

            .filter {
                height: 22px;
                padding: 0 8px;
                font-size: 12px;
                font-weight: 600;
                letter-spacing: 0.04em;
                border-radius: calc(var(--radius) - 1px);
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 5px;
                transition: background 0.12s, color 0.12s, opacity 0.12s;
                color: var(--fg-muted);
                background: transparent;
                opacity: 0.45;
            }

            .filter:hover {
                opacity: 0.75;
                background: var(--accent-bg);
            }

            .filter.active {
                opacity: 1;
            }

            .filter[data-type="all"].active {
                color: var(--fg);
                background: var(--accent-bg);
            }

            .filter[data-type="info"].active {
                color: var(--log-info);
                background: hsl(220 13% 78%/0.1);
            }

            .filter[data-type="warn"].active {
                color: var(--log-warn);
                background: hsl(38 92% 66%/0.1);
            }

            .filter[data-type="error"].active {
                color: var(--log-error);
                background: hsl(0 72% 66%/0.1);
            }

            .filter-dot {
                width: 5px;
                height: 5px;
                border-radius: 50%;
                background: currentColor;
                flex-shrink: 0;
            }

            .filter-count {
                font-size: 10px;
                font-weight: 700;
                opacity: 0.6;
            }

            .log-row.hidden {
                display: none;
            }

            .tabbar-actions {
                margin-left: auto;
                display: flex;
                align-items: center;
                gap: 4px;
                padding-right: 4px;
            }

            .icon-btn {
                width: 26px;
                height: 26px;
                border-radius: calc(var(--radius) - 2px);
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--fg-muted);
                cursor: pointer;
                border: none;
                background: transparent;
                transition: background 0.12s, color 0.12s;
            }

            .icon-btn-labeled {
                width: auto;
                height: 22px;
                padding: 0 8px;
                gap: 5px;
                background: var(--badge-bg);
            }

            .btn-label {
                font-size: 11.5px;
                font-weight: 600;
                letter-spacing: 0.02em;
            }

            .icon-btn:hover {
                background: var(--accent-bg);
                color: var(--fg);
            }

            .log-body {
                flex: 1;
                overflow-y: auto;
                padding: 10px 0;
                scroll-behavior: smooth;
            }

            .log-body::-webkit-scrollbar {
                width: 6px;
            }

            .log-body::-webkit-scrollbar-track {
                background: transparent;
            }

            .log-body::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 9px;
            }

            .log-body::-webkit-scrollbar-thumb:hover {
                background: hsl(0 0% 25%);
            }

            .log-row {
                display: flex;
                align-items: baseline;
                padding: 4px 14px;
                margin-bottom: 2px;
                white-space: pre-wrap;
                word-break: break-all;
                transition: background 0.08s;
                height: 25px;
                line-height: 25px;
            }

            .log-row:hover {
                background: hsl(0 0% 100%/0.03);
            }

            .log-row.info {
                color: var(--log-info);
            }

            .log-row.warn {
                color: var(--log-warn);
            }

            .log-row.error {
                color: var(--log-error);
            }

            .log-ts {
                color: var(--fg-muted);
                font-family: 'Geist Mono', monospace;
                font-size: 12.5px;
                min-width: 88px;
                flex-shrink: 0;
                letter-spacing: 0.0em;
            }

            .log-level {
                opacity: 0.55;
                min-width: 46px;
                font-family: 'Geist Mono', monospace;
                font-size: 11px;
                font-weight: 800;
                flex-shrink: 0;
                letter-spacing: 0.05em;
            }

            .log-msg {
                flex: 1;
                font-size: 13px;
                letter-spacing: 0.01em;
            }

            .badge {
                display: none;
                margin-left: 10px;
                padding: 1px 6px;
                font-size: 11px;
                font-weight: 700;
                letter-spacing: 0.04em;
                border-radius: calc(var(--radius) - 2px);
                flex-shrink: 0;
                align-self: center;
                line-height: 1.3;
                background: var(--badge-bg);
                color: var(--badge-fg);
                transition: transform 0.07s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .badge.visible {
                display: inline-block;
            }

            .input-bar {
                height: 38px;
                display: flex;
                align-items: center;
                padding: 0 14px;
                border-top: 1px solid var(--border);
                gap: 8px;
                background: var(--bg-deep);
                flex-shrink: 0;
            }

            .input-prompt {
                color: var(--fg-muted);
                font-size: 13px;
                flex-shrink: 0;
            }

            .input-field {
                flex: 1;
                background: transparent;
                border: none;
                outline: none;
                color: var(--fg-muted);
                font-family: inherit;
                font-size: 13px;
                caret-color: var(--log-info);
            }

            .input-field::placeholder {
                color: var(--fg-muted);
                opacity: 0.6;
            }

            .resize-handle {
                position: absolute;
                right: 3px;
                bottom: 3px;
                width: 14px;
                height: 14px;
                cursor: se-resize;
                overflow: hidden;
                opacity: 0.3;
            }

            .resize-handle::before,
            .resize-handle::after,
            .resize-handle span {
                content: '';
                position: absolute;
                background: var(--fg-muted);
                width: 140%;
                height: 1px;
                transform-origin: right center;
                transform: rotate(-45deg);
                right: 0;
            }

            .resize-handle::before {
                bottom: 1px;
            }

            .resize-handle span {
                bottom: 5px;
            }

            .resize-handle::after {
                bottom: 9px;
            }

            .resize-handle:hover {
                opacity: 0.8;
            }
        </style>
    </head>

    <body>
        <!-- React -->
        <div id="root"></div>
        <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <script type="text/babel">
            // CONSTANTS
            const { useState, useEffect, useRef, useCallback } = React;
            const LEVEL_LABELS = { info: 'INFO', warn: 'WARN', error: 'ERRO' };
            const GROUP_MS = 5000;

            // UTILITIES
            const make_key = (type, msg) => {
                return type + '\x00' + msg
                    .replace(/\d+\.\d+/g, '#')
                    .replace(/\b\d+\b/g, '#')
                    .replace(/\s+/g, ' ')
                    .trim();
            };

            // ICONS
            const TrashIcon = () => (
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"
                    strokeLinecap="round" strokeLinejoin="round">
                    <path d="M3 6h18"/>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            );

            const ResetIcon = () => (
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"
                    strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    <polyline points="7.5 4.21 12 6.81 16.5 4.21"/>
                    <polyline points="7.5 19.79 7.5 14.6 3 12"/>
                    <polyline points="21 12 16.5 14.6 16.5 19.79"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>
            );

            // COMPONENTS
            const FilterButton = ({ type, label, count, is_active, on_click }) => (
                <div className={`filter ${is_active ? 'active' : ''}`} data-type={type} onClick={on_click}>
                    <div className="filter-dot"></div>
                    {label}
                    {count > 0 && <span className="filter-count"> ({count})</span>}
                </div>
            );

            const ActionButton = ({ icon, label, on_click }) => (
                <button className="icon-btn icon-btn-labeled" onClick={on_click}>
                    {icon}
                    <span className="btn-label">{label}</span>
                </button>
            );

            const LogRow = ({ type, timestamp, message, repeat_count, is_hidden }) => (
                <div className={`log-row ${type} ${is_hidden ? 'hidden' : ''}`}>
                    <span className="log-ts">{timestamp}</span>
                    <span className="log-level">{LEVEL_LABELS[type] ?? type.toUpperCase()}</span>
                    <span className="log-msg">{message}</span>
                    {repeat_count > 1 && <span className="badge visible">x{repeat_count}</span>}
                </div>
            );

            // MAIN CONSOLE COMPONENT
            const SandboxConsole = () => {
                // State
                const [logs, set_logs] = useState([]);
                const [active_filters, set_active_filters] = useState(new Set(['info', 'warn', 'error']));
                const [position, set_position] = useState({ x: 0, y: 0 });
                const [size, set_size] = useState({ width: '35vw', height: '30vh' });
                const [command_input, set_command_input] = useState('');
                const [is_dragging, set_is_dragging] = useState(false);

                // Refs
                const console_ref = useRef(null);
                const log_body_ref = useRef(null);
                const group_map_ref = useRef(new Map());
                const drag_offset_ref = useRef({ x: 0, y: 0 });

                // Calculate counts
                const log_counts = logs.reduce((acc, log) => {
                    acc[log.type] = (acc[log.type] || 0) + 1;
                    return acc;
                }, { info: 0, warn: 0, error: 0 });

                const total_count = log_counts.info + log_counts.warn + log_counts.error;

                // Log Management
                const add_log = useCallback((type, message, timestamp = null) => {
                    const ts = timestamp || new Date().toTimeString().slice(0, 8);
                    const now = Date.now();
                    const key = make_key(type, message);

                    // Clean expired groups
                    for (const [k, entry] of group_map_ref.current) {
                        if (now >= entry.expires_at) {
                            group_map_ref.current.delete(k);
                        }
                    }

                    const existing = group_map_ref.current.get(key);

                    if (existing) {
                        // Update existing log
                        existing.count++;
                        existing.expires_at = now + GROUP_MS;
                        existing.timestamp = ts;

                        set_logs(prev_logs =>
                            prev_logs.map(log =>
                                log.id === existing.id
                                    ? { ...log, repeat_count: existing.count, timestamp: ts }
                                    : log
                            )
                        );

                        // Auto-scroll if at bottom
                        setTimeout(() => {
                            const log_el = log_body_ref.current;
                            if (log_el) {
                                const at_bottom = log_el.scrollHeight - log_el.scrollTop - log_el.clientHeight < 6;
                                if (at_bottom) log_el.scrollTop = log_el.scrollHeight;
                            }
                        }, 0);
                    } else {
                        // Add new log
                        const new_log = {
                            id: Date.now() + Math.random(),
                            type,
                            message,
                            timestamp: ts,
                            repeat_count: 1
                        };

                        group_map_ref.current.set(key, {
                            id: new_log.id,
                            count: 1,
                            expires_at: now + GROUP_MS,
                            timestamp: ts
                        });

                        set_logs(prev_logs => [...prev_logs, new_log]);

                        // Auto-scroll to bottom
                        setTimeout(() => {
                            const log_el = log_body_ref.current;
                            if (log_el) log_el.scrollTop = log_el.scrollHeight;
                        }, 0);
                    }
                }, []);

                const clear_logs = useCallback(() => {
                    set_logs([]);
                    group_map_ref.current.clear();
                }, []);

                // Command Handling
                const handle_command = useCallback((command) => {
                    const timestamp = new Date().toTimeString().slice(0, 8);
                    add_log('info', `Command executed: ${command}`, timestamp);

                    try {
                        const result = eval(command);
                        if (result !== undefined) {
                            add_log('info', `Result: ${result}`, timestamp);
                        }
                    } catch (error) {
                        add_log('error', `Error: ${error.message}`, timestamp);
                    }
                }, [add_log]);

                const handle_key_down = useCallback((e) => {
                    if (e.key === 'Enter' && command_input.trim() !== '') {
                        handle_command(command_input);
                        set_command_input('');
                    }
                }, [command_input, handle_command]);

                // Filter Management
                const toggle_filter = useCallback((type) => {
                    if (type === 'all') {
                        if (active_filters.size === 3) {
                            set_active_filters(new Set());
                        } else {
                            set_active_filters(new Set(['info', 'warn', 'error']));
                        }
                    } else {
                        set_active_filters(prev => {
                            const new_filters = new Set(prev);
                            if (new_filters.has(type)) {
                                new_filters.delete(type);
                            } else {
                                new_filters.add(type);
                            }
                            return new_filters;
                        });
                    }
                }, [active_filters.size]);

                // Position Management
                const reset_position = useCallback(() => {
                    set_position({ x: 0, y: 0 });
                }, []);

                // Drag Handlers
                const handle_mouse_down = useCallback((e) => {
                    if (e.target.closest('.icon-btn, .filter')) return;
                    e.preventDefault();
                    set_is_dragging(true);

                    const rect = console_ref.current.getBoundingClientRect();
                    drag_offset_ref.current = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                }, []);

                const handle_mouse_move = useCallback((e) => {
                    if (!is_dragging) return;
                    set_position({
                        x: e.clientX - drag_offset_ref.current.x,
                        y: e.clientY - drag_offset_ref.current.y
                    });
                }, [is_dragging]);

                const handle_mouse_up = useCallback(() => {
                    set_is_dragging(false);
                }, []);

                // Resize Handlers
                const handle_resize_start = useCallback((e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const start_x = e.clientX;
                    const start_y = e.clientY;
                    const rect = console_ref.current.getBoundingClientRect();
                    const start_width = rect.width;
                    const start_height = rect.height;

                    const handle_resize_move = (e) => {
                        const new_width = Math.max(400, start_width + e.clientX - start_x);
                        const new_height = Math.max(260, start_height + e.clientY - start_y);
                        set_size({ width: new_width + 'px', height: new_height + 'px' });
                    };

                    const handle_resize_end = () => {
                        document.removeEventListener('mousemove', handle_resize_move);
                        document.removeEventListener('mouseup', handle_resize_end);
                    };

                    document.addEventListener('mousemove', handle_resize_move);
                    document.addEventListener('mouseup', handle_resize_end);
                }, []);

                // Drag event listeners
                useEffect(() => {
                    if (is_dragging) {
                        document.addEventListener('mousemove', handle_mouse_move);
                        document.addEventListener('mouseup', handle_mouse_up);
                        return () => {
                            document.removeEventListener('mousemove', handle_mouse_move);
                            document.removeEventListener('mouseup', handle_mouse_up);
                        };
                    }
                }, [is_dragging, handle_mouse_move, handle_mouse_up]);

                // Load demo logs
                useEffect(() => {
                    const demo_lines = [
                        { type: 'info', msg: () => 'vital.sandbox:draw' },
                        { type: 'info', msg: () => 'Incoming network execution' },
                        { type: 'info', msg: () => 'vital.sandbox:process ' + (Math.random() * 0.01).toFixed(16) },
                        { type: 'warn', msg: () => 'Memory usage: ' + (Math.random() * 100).toFixed(2) + 'MB' },
                        { type: 'error', msg: () => 'Connection timeout' },
                        { type: 'info', msg: () => 'vital.sandbox:ready' },
                    ];

                    for (let i = 0; i < 80; i++) {
                        const entry = demo_lines[i % demo_lines.length];
                        const seconds = (Math.floor(i / demo_lines.length) % 60).toString().padStart(2, '0');
                        add_log(entry.type, entry.msg(), '06:10:' + seconds);
                    }
                }, [add_log]);

                // Prevent context menu
                useEffect(() => {
                    const prevent_context = (e) => e.preventDefault();
                    document.addEventListener('contextmenu', prevent_context);
                    return () => document.removeEventListener('contextmenu', prevent_context);
                }, []);

                // Render
                return (
                    <div
                        ref={console_ref}
                        className="console"
                        style={{
                            left: `${position.x}px`,
                            top: `${position.y}px`,
                            width: size.width,
                            height: size.height
                        }}
                    >
                        {/* Header */}
                        <div className={`header ${is_dragging ? 'dragging' : ''}`} onMouseDown={handle_mouse_down}>
                            <span className="titlebar-label">Console</span>
                            <div className="header-divider"></div>

                            {/* Filters */}
                            <div className="filters">
                                <FilterButton type="all" label="All" count={total_count} is_active={active_filters.size === 3} on_click={() => toggle_filter('all')}/>
                                <FilterButton type="info" label="Info" count={log_counts.info} is_active={active_filters.has('info')} on_click={() => toggle_filter('info')}/>
                                <FilterButton type="warn" label="Warn" count={log_counts.warn} is_active={active_filters.has('warn')} on_click={() => toggle_filter('warn')}/>
                                <FilterButton type="error" label="Error" count={log_counts.error} is_active={active_filters.has('error')} on_click={() => toggle_filter('error')}/>
                            </div>

                            {/* Actions */}
                            <div className="tabbar-actions">
                                <ActionButton icon={<ResetIcon/>} label="Reset" on_click={reset_position}/>
                                <ActionButton icon={<TrashIcon/>} label="Clear" on_click={clear_logs}/>
                            </div>
                        </div>

                        {/* Log Body */}
                        <div ref={log_body_ref} className="log-body">
                            {logs.map(log => (
                                <LogRow key={log.id} type={log.type} timestamp={log.timestamp}
                                    message={log.message} repeat_count={log.repeat_count}
                                    is_hidden={!active_filters.has(log.type)}/>
                            ))}
                        </div>

                        {/* Input Bar */}
                        <div className="input-bar">
                            <span className="input-prompt">‚ùØ</span>
                            <input className="input-field" value={command_input}
                                onChange={(e) => set_command_input(e.target.value)}
                                onKeyDown={handle_key_down}
                                placeholder="Enter command or expression..."
                                autoComplete="off" spellCheck="false"/>
                        </div>

                        {/* Resize Handle */}
                        <div className="resize-handle" onMouseDown={handle_resize_start}>
                            <span></span>
                        </div>
                    </div>
                );
            };

            // RENDER APP
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<SandboxConsole/>);
        </script>
    </body>
</html>